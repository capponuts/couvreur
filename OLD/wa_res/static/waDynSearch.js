onmessage=function(r){var e=r.data[0],e=(e.code,e.param),e=new SearchWorker(e).loadJson();postMessage([e])};class SearchWorker{constructor(r){this.m_restriction_keys=r.restriction_keys,this.m_json_index=r.json_index,this.m_context_search=r.context_search,this.m_query=this.m_context_search.m_query}loadJson(){var e=this,t={success:!1,search_results:[]},r=new XMLHttpRequest;return r.onreadystatechange=function(){var r;4==this.readyState&&200==this.status&&(r=JSON.parse(this.responseText),t.search_results=e.doSearch(r),t.success=!0)},r.onerror=function(){console.log("** An error occurred during the search json loading")},r.open("GET",this.m_json_index,!1),r.send(),t.context_search=this.m_context_search,t}doSearch(r){for(var c=IntuisphereFtSearch.OPERATOR_AND,l=IntuisphereFtSearch.splitQuery(this.m_query),e=[],t=0;t<l.length;t++){var u=l[t].trim();if(0<u.length){for(var m=[],d=this.doSearchWithWord(r,u),s=0;s<d.length;s++)var p=d[s],p=r.index_words[p],m=m.concat(p);var a=Array.from(new Set(m)),e=c==IntuisphereFtSearch.OPERATOR_AND?0==t?a:e.filter(r=>a.includes(r)):e.concat(a)}}c==IntuisphereFtSearch.OPERATOR_OR&&(e=Array.from(new Set(e)));for(var n=[],h=0;h<e.length;h++){var i=e[h];if(0==(W=r.map_targets[i]).is_page)for(var S=r.map_widget_pages[i],o=0;o<S.length;o++){var g=S[o];n.push(g)}else n.push(i)}for(var n=Array.from(new Set(n)),_=[],k=0;k<n.length;k++){var i=n[k],W=r.map_targets[i];_.push(W)}return _=0<this.m_restriction_keys.length?_.filter(r=>this.m_restriction_keys.includes(r)):_}internal_almostMatch(r,e){var t=r.length,s=e.length;if(Math.abs(t-s)<3){t=Math.min(t,s);if(2<t&&(r=r.substring(0,t))==(e=e.substring(0,t)))return!0}return!1}internal_compareWord(r,e,t){return t==SearchWorker.CMP_EXACT_MATCH?r==e:t==SearchWorker.CMP_STARTS_WITH&&r.startsWith(e)}internal_CreateSearchResultsWithWord(r,e,t){for(var s=[],a=r.map_words,n=0;n<a.length;n++){var h=a[n];this.internal_compareWord(h,e,t)&&s.push(n)}return s}doSearchWithWord(r,e){var t=this.internal_CreateSearchResultsWithWord(r,e,SearchWorker.CMP_EXACT_MATCH),s=this.internal_CreateSearchResultsWithWord(r,e,SearchWorker.CMP_STARTS_WITH);return t=Array.from(new Set(t.concat(s)))}}SearchWorker.CMP_ALMOST_MATCH=1,SearchWorker.CMP_EXACT_MATCH=2,SearchWorker.CMP_STARTS_WITH=3;class IntuisphereFtSearch{constructor(r){this.m_restriction_keys=[],this.m_current_results=[],this.m_hash_database=r.hash_database,this.m_hash_js=r.hash_js,this.m_json_index=r.json_index,this.m_js_worker=r.js_worker,this.m_worker=null,this.callback=function(){res.success&&console.log("DEFAULT "+res.search_results.join(" ; "))}}static splitQuery(r){var e=r.trim().toLowerCase().split(/[^\p{L}\p{N}]+/gu).filter(r=>0<r.length).map(r=>r.normalize("NFD").replace(/[^\p{L}\p{N}]/gu,"").trim()).filter(r=>2<r.length);return console.log(e),e}setRestrictionKeys(r){this.m_restriction_keys=r}results(){return this.m_current_results}search(r){var t=this;null!==this.m_worker&&this.m_worker.terminate(),this.m_worker=new Worker(this.m_js_worker+"?"+this.m_hash_js),this.m_worker.onmessage=function(r){var e=r.data[0];t.m_current_results=e.search_results,t.then(e)},this.m_worker.postMessage([{code:"init",param:{json_index:this.m_json_index+"?"+this.m_hash_database,restriction_keys:this.m_restriction_keys,context_search:r}}])}then(r){this.callback(r)}}IntuisphereFtSearch.OPERATOR_AND=0,IntuisphereFtSearch.OPERATOR_OR=1;