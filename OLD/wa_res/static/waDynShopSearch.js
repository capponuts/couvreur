onmessage=function(r){var e=r.data[0],e=(e.code,e.param),e=new SearchWorker(e).loadJson();console.log("res="+e),postMessage([e])};class SearchWorker{constructor(r){this.m_restriction_keys=r.restriction_keys,this.m_json_index=r.json_index,this.m_context_search=r.context_search,this.m_query=this.m_context_search.m_query}loadJson(){var e=this,t={success:!1,search_results:[]},r=new XMLHttpRequest;return r.onreadystatechange=function(){var r;4==this.readyState&&(200==this.status?(r=JSON.parse(this.responseText),t.search_results=e.doSearch(r),t.success=!0):console.log("loadJson status="+this.status+"  "+e.m_json_index))},r.onerror=function(){console.log("** An error occurred during the search json loading")},r.open("GET",this.m_json_index,!1),r.send(),t.context_search=this.m_context_search,t}doSearch(r){for(var c=IntuisphereShopSearch.OPERATOR_AND,u=IntuisphereShopSearch.splitQuery(this.m_query),e=[],t=0;t<u.length;t++){var l=u[t].trim();if(0<l.length){for(var m=[],S=this.doSearchWithWord(r,l),s=0;s<S.length;s++)var d=S[s],d=r.index_words[d],m=m.concat(d);var a=Array.from(new Set(m)),e=c==IntuisphereShopSearch.OPERATOR_AND?0==t?a:e.filter(r=>a.includes(r)):e.concat(a)}}c==IntuisphereShopSearch.OPERATOR_OR&&(e=Array.from(new Set(e)));for(var h=[],n=0;n<e.length;n++){var o=e[n],p=r.map_targets[o];h.push(o)}for(var h=Array.from(new Set(h)),i=[],_=0;_<h.length;_++){o=h[_],p=r.map_targets[o];i.push(p)}return i=0<this.m_restriction_keys.length?i.filter(r=>this.m_restriction_keys.includes(r)):i}internal_almostMatch(r,e){var t=r.length,s=e.length;if(Math.abs(t-s)<3){t=Math.min(t,s);if(2<t&&(r=r.substring(0,t))==(e=e.substring(0,t)))return!0}return!1}internal_compareWord(r,e,t){return t==SearchWorker.CMP_EXACT_MATCH?r==e:t==SearchWorker.CMP_STARTS_WITH&&r.startsWith(e)}internal_CreateSearchResultsWithWord(r,e,t){for(var s=[],a=r.map_words,h=0;h<a.length;h++){var n=a[h];this.internal_compareWord(n,e,t)&&s.push(h)}return s}doSearchWithWord(r,e){var t=this.internal_CreateSearchResultsWithWord(r,e,SearchWorker.CMP_EXACT_MATCH),s=this.internal_CreateSearchResultsWithWord(r,e,SearchWorker.CMP_STARTS_WITH);return t=Array.from(new Set(t.concat(s)))}}SearchWorker.CMP_ALMOST_MATCH=1,SearchWorker.CMP_EXACT_MATCH=2,SearchWorker.CMP_STARTS_WITH=3;class IntuisphereShopSearch{constructor(r){this.m_restriction_keys=[],this.m_current_results=[],this.m_hash_database=r.hash_database,this.m_hash_js=r.hash_js,this.m_json_index=r.json_index,this.m_js_worker=r.js_worker,this.m_worker=null,this.callback=function(r){r.success&&console.log("DEFAULT "+r.search_results.join(" ; "))}}static splitQuery(r){for(var e=[],t=(r=(r=(r=r.replace(/[^\x20\x2D0-9A-Z\x5Fa-z\xC0-\xD6\xD8-\xF6\xF8-\xFF]/g,"")).toLowerCase().trim()).normalize("NFD").replace(/[\u0300-\u036f]/g,"")).split(" "),s=0;s<t.length;s++){var a=t[s].trim();0<a.length&&e.push(a)}return e}setRestrictionKeys(r){this.m_restriction_keys=r}results(){return this.m_current_results}search(r){var t=this;null!==this.m_worker&&this.m_worker.terminate(),this.m_worker=new Worker(this.m_js_worker+"?"+this.m_hash_js),this.m_worker.onerror=function(r){alert(r.message)},this.m_worker.onmessage=function(r){var e=r.data[0];t.m_current_results=e.search_results,t.then(e)},this.m_worker.postMessage([{code:"init",param:{json_index:this.m_json_index+"?"+this.m_hash_database,restriction_keys:this.m_restriction_keys,context_search:r}}])}then(r){this.callback(r)}}IntuisphereShopSearch.OPERATOR_AND=0,IntuisphereShopSearch.OPERATOR_OR=1;